name: clippy

# Why `on: repository_dispatch`?
#
# If we trigger this action on pull_request events,
# then it will run with the forked repo GITHUB_TOKEN
# this is a problem as it won't allow the action to write
# a comment on the PR in the last step.
#
# instead, we trigger this remotely via a bot we're running ourselves.
on:
  repository_dispatch:
    types: [new_PR]

jobs:
  run_clippy:
    runs-on: ubuntu-latest

    steps:
      - name: Who triggered this?
        env:
          PULL_ID: ${{ github.event.client_payload.pull_id }}
        run: |
          echo "action triggerd by https://github.com/libra/libra/pull/$PULL_ID"
      - name: Checkout libra
        if: success()
        uses: actions/checkout@v2
        with:
          path: "libra"
          fetch-depth: 50 # this is to make sure we obtain the target base commit
          repository: ${{ github.event.client_payload.owner }}/${{ github.event.client_payload.repo }} # repo of the forked libra/libra
          ref: ${{ github.event.client_payload.pull_ref }} # commit that triggered the PR
      - name: Build target base then checkout PR to only run Clippy on the changes
        if: success()
        working-directory: ./libra
        env:
          BASE: ${{ github.event.client_payload.base_ref }}
        run: |
          set -x
          rustup update
          rustup component add clippy
          git checkout $BASE
          # we should always be able to build $BASE
          cargo clippy -q --workspace -- -W clippy::all -W clippy::pedantic -W clippy::nursery -W clippy::cargo -W clippy::as_conversions -W clippy::await_holding_lock -W clippy::cargo_common_metadata -W clippy::cast_lossless -W clippy::cast_possible_truncation -W clippy::cast_possible_wrap -W clippy::cast_precision_loss -W clippy::cast_ptr_alignment -W clippy::cast_sign_loss -W clippy::checked_conversions -W clippy::clone_on_ref_ptr -W clippy::cognitive_complexity -W clippy::copy_iterator -W clippy::create_dir -W clippy::dbg_macro -W clippy::debug_assert_with_mut_call -W clippy::decimal_literal_representation -W clippy::default_trait_access -W clippy::doc_markdown -W clippy::else_if_without_else -W clippy::empty_enum -W clippy::empty_line_after_outer_attr -W clippy::enum_glob_use -W clippy::exit -W clippy::expect_used -W clippy::expl_impl_clone_on_copy -W clippy::explicit_deref_methods -W clippy::explicit_into_iter_loop -W clippy::explicit_iter_loop -W clippy::fallible_impl_from -W clippy::filetype_is_file -W clippy::filter_map -W clippy::filter_map_next -W clippy::find_map -W clippy::float_arithmetic -W clippy::float_cmp_const -W clippy::fn_params_excessive_bools -W clippy::future_not_send -W clippy::get_unwrap -W clippy::if_not_else -W clippy::implicit_hasher -W clippy::implicit_return -W clippy::implicit_saturating_sub -W clippy::imprecise_flops -W clippy::indexing_slicing -W clippy::inefficient_to_string -W clippy::inline_always -W clippy::integer_arithmetic -W clippy::integer_division -W clippy::invalid_upcast_comparisons -W clippy::items_after_statements -W clippy::large_digit_groups -W clippy::large_stack_arrays -W clippy::let_underscore_must_use -W clippy::let_unit_value -W clippy::linkedlist -W clippy::lossy_float_literal -W clippy::macro_use_imports -W clippy::map_flatten -W clippy::map_unwrap_or -W clippy::match_bool -W clippy::match_on_vec_items -W clippy::match_same_arms -W clippy::match_wild_err_arm -W clippy::match_wildcard_for_single_variants -W clippy::maybe_infinite_iter -W clippy::mem_forget -W clippy::missing_const_for_fn -W clippy::missing_docs_in_private_items -W clippy::missing_errors_doc -W clippy::missing_inline_in_public_items -W clippy::module_name_repetitions -W clippy::modulo_arithmetic -W clippy::multiple_crate_versions -W clippy::multiple_inherent_impl -W clippy::must_use_candidate -W clippy::mut_mut -W clippy::mutex_integer -W clippy::needless_borrow -W clippy::needless_continue -W clippy::needless_pass_by_value -W clippy::non_ascii_literal -W clippy::option_if_let_else -W clippy::option_option -W clippy::panic -W clippy::panic_in_result_fn -W clippy::path_buf_push_overwrite -W clippy::pattern_type_mismatch -W clippy::print_stdout -W clippy::pub_enum_variant_names -W clippy::range_minus_one -W clippy::range_plus_one -W clippy::redundant_closure_for_method_calls -W clippy::redundant_pub_crate -W clippy::rest_pat_in_fully_bound_structs -W clippy::same_functions_in_if_condition -W clippy::shadow_reuse -W clippy::shadow_same -W clippy::shadow_unrelated -W clippy::similar_names -W clippy::single_match_else -W clippy::string_add -W clippy::string_add_assign -W clippy::struct_excessive_bools -W clippy::suboptimal_flops -W clippy::todo -W clippy::too_many_lines -W clippy::trait_duplication_in_bounds -W clippy::trivially_copy_pass_by_ref -W clippy::type_repetition_in_bounds -W clippy::unicode_not_nfc -W clippy::unimplemented -W clippy::unneeded_field_pattern -W clippy::unnested_or_patterns -W clippy::unreachable -W clippy::unreadable_literal -W clippy::unsafe_derive_deserialize -W clippy::unseparated_literal_suffix -W clippy::unused_self -W clippy::unwrap_in_result -W clippy::unwrap_used -W clippy::use_debug -W clippy::use_self -W clippy::used_underscore_binding -W clippy::useless_let_if_seq -W clippy::useless_transmute -W clippy::verbose_bit_mask -W clippy::verbose_file_reads -W clippy::wildcard_dependencies -W clippy::wildcard_enum_match_arm -W clippy::wildcard_imports -W clippy::wrong_pub_self_convention | tee ../before_PR
          git checkout -
      - name: Run Clippy on PR (this step can fail if cargo can't build the PR)
        if: success()
        working-directory: ./libra
        timeout-minutes: 60
        run: |
          set -o pipefail
          cargo clippy -q --workspace -- -W clippy::all -W clippy::pedantic -W clippy::nursery -W clippy::cargo -W clippy::as_conversions -W clippy::await_holding_lock -W clippy::cargo_common_metadata -W clippy::cast_lossless -W clippy::cast_possible_truncation -W clippy::cast_possible_wrap -W clippy::cast_precision_loss -W clippy::cast_ptr_alignment -W clippy::cast_sign_loss -W clippy::checked_conversions -W clippy::clone_on_ref_ptr -W clippy::cognitive_complexity -W clippy::copy_iterator -W clippy::create_dir -W clippy::dbg_macro -W clippy::debug_assert_with_mut_call -W clippy::decimal_literal_representation -W clippy::default_trait_access -W clippy::doc_markdown -W clippy::else_if_without_else -W clippy::empty_enum -W clippy::empty_line_after_outer_attr -W clippy::enum_glob_use -W clippy::exit -W clippy::expect_used -W clippy::expl_impl_clone_on_copy -W clippy::explicit_deref_methods -W clippy::explicit_into_iter_loop -W clippy::explicit_iter_loop -W clippy::fallible_impl_from -W clippy::filetype_is_file -W clippy::filter_map -W clippy::filter_map_next -W clippy::find_map -W clippy::float_arithmetic -W clippy::float_cmp_const -W clippy::fn_params_excessive_bools -W clippy::future_not_send -W clippy::get_unwrap -W clippy::if_not_else -W clippy::implicit_hasher -W clippy::implicit_return -W clippy::implicit_saturating_sub -W clippy::imprecise_flops -W clippy::indexing_slicing -W clippy::inefficient_to_string -W clippy::inline_always -W clippy::integer_arithmetic -W clippy::integer_division -W clippy::invalid_upcast_comparisons -W clippy::items_after_statements -W clippy::large_digit_groups -W clippy::large_stack_arrays -W clippy::let_underscore_must_use -W clippy::let_unit_value -W clippy::linkedlist -W clippy::lossy_float_literal -W clippy::macro_use_imports -W clippy::map_flatten -W clippy::map_unwrap_or -W clippy::match_bool -W clippy::match_on_vec_items -W clippy::match_same_arms -W clippy::match_wild_err_arm -W clippy::match_wildcard_for_single_variants -W clippy::maybe_infinite_iter -W clippy::mem_forget -W clippy::missing_const_for_fn -W clippy::missing_docs_in_private_items -W clippy::missing_errors_doc -W clippy::missing_inline_in_public_items -W clippy::module_name_repetitions -W clippy::modulo_arithmetic -W clippy::multiple_crate_versions -W clippy::multiple_inherent_impl -W clippy::must_use_candidate -W clippy::mut_mut -W clippy::mutex_integer -W clippy::needless_borrow -W clippy::needless_continue -W clippy::needless_pass_by_value -W clippy::non_ascii_literal -W clippy::option_if_let_else -W clippy::option_option -W clippy::panic -W clippy::panic_in_result_fn -W clippy::path_buf_push_overwrite -W clippy::pattern_type_mismatch -W clippy::print_stdout -W clippy::pub_enum_variant_names -W clippy::range_minus_one -W clippy::range_plus_one -W clippy::redundant_closure_for_method_calls -W clippy::redundant_pub_crate -W clippy::rest_pat_in_fully_bound_structs -W clippy::same_functions_in_if_condition -W clippy::shadow_reuse -W clippy::shadow_same -W clippy::shadow_unrelated -W clippy::similar_names -W clippy::single_match_else -W clippy::string_add -W clippy::string_add_assign -W clippy::struct_excessive_bools -W clippy::suboptimal_flops -W clippy::todo -W clippy::too_many_lines -W clippy::trait_duplication_in_bounds -W clippy::trivially_copy_pass_by_ref -W clippy::type_repetition_in_bounds -W clippy::unicode_not_nfc -W clippy::unimplemented -W clippy::unneeded_field_pattern -W clippy::unnested_or_patterns -W clippy::unreachable -W clippy::unreadable_literal -W clippy::unsafe_derive_deserialize -W clippy::unseparated_literal_suffix -W clippy::unused_self -W clippy::unwrap_in_result -W clippy::unwrap_used -W clippy::use_debug -W clippy::use_self -W clippy::used_underscore_binding -W clippy::useless_let_if_seq -W clippy::useless_transmute -W clippy::verbose_bit_mask -W clippy::verbose_file_reads -W clippy::wildcard_dependencies -W clippy::wildcard_enum_match_arm -W clippy::wildcard_imports -W clippy::wrong_pub_self_convention | tee ../after_PR
      - name: Get diff
        if: success()
        working-directory: ./libra
        run: |
          diff -u before_PR after_PR | sed -n '/^+[^+]/ s/^+//p' | tee ../changes
